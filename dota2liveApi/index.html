<!DOCTYPE html>
<html>
<head>
    <title>SignalR Dota 2 Live Games</title>
    
    <link rel="stylesheet" href="Content/bootstrap.css" />
</head>
<body>
    <div class="container">
        <table class="table" id="dataTable">

        </table>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.1.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            // Declare a proxy to reference the hub.
            var stats = $.connection.mainHub;
     
            // Create a function that the hub can call to broadcast messages.
            stats.client.broadcastMessage = function (message) {
                // Save the "JSON" sent from the server. This is not valid json. Will have to write something to parse JSON string to object. "JSON" has duplicate keys
                // Could not get server side to parse json easily jquery.parseJSON did ok but didn't parse the properties with duplicate keys
                var ValveObject = jQuery.parseJSON(message);
              
                //Filter unimportant games
                var upperTierGames = jQuery.grep(ValveObject.result.games, function (obj) {
                    return obj.league_tier === 2;
                });
               
                //add values from selected array of object to table
                var r = new Array(), j = -1;
                r[++j] = "<tr><th>Teams</th><th>Game length</th><th>Score</th><th>Series score</th><th>Spectators</th><tr>"
                for (var key = 0, size = upperTierGames.length; key < size; key++) {
                    r[++j] = '<tr><td>';
                    r[++j] = (upperTierGames[key].radiant_team  ?  upperTierGames[key].radiant_team.team_name : "Radient") + ' - ' + (upperTierGames[key].dire_team  ?  upperTierGames[key].dire_team.team_name : "Dire") ;
                    r[++j] = '</td><td>';
                    r[++j] = upperTierGames[key].scoreboard ? upperTierGames[key].scoreboard.duration == 0 ? "Not Started" : Math.floor(upperTierGames[key].scoreboard.duration / 60) + ' min' : '';
                    r[++j] = '</td><td>';
                    r[++j] = (upperTierGames[key].scoreboard ? upperTierGames[key].scoreboard.radiant.score + ' - ' + upperTierGames[key].scoreboard.dire.score : '');
                    r[++j] = '</td><td>';
                    r[++j] = upperTierGames[key].radiant_series_wins + ' - ' + upperTierGames[key].dire_series_wins;
                    r[++j] = '</td><td>';
                    r[++j] = upperTierGames[key].spectators;
                    r[++j] = '</td></tr>';
                }
                var rtext = r.join('');
                //add table markup to dataTable table
                $('#dataTable').html(rtext);
             
                console.log(upperTierGames);
              
            };

            // Start the connection.
            $.connection.hub.start().done(function () {
              
            });
        });
    </script>
</body>
</html>